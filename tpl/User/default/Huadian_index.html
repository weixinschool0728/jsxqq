
<include file="Public:head"/>
<script src="./tpl/User/default/common/js/date/WdatePicker.js"></script>
<script src="/tpl/static/artDialog/jquery.artDialog.js?skin=default"></script>
<script src="/tpl/static/artDialog/plugins/iframeTools.js"></script>

<link rel="stylesheet" href="{weimicms::STATICS}/kindeditor/themes/default/default.css" />
<link rel="stylesheet" href="{weimicms::STATICS}/kindeditor/plugins/code/prettify.css" />
<script src="{weimicms::STATICS}/kindeditor/kindeditor.js" type="text/javascript"></script>
<script src="{weimicms::STATICS}/kindeditor/lang/zh_CN.js" type="text/javascript"></script>
<script src="{weimicms::STATICS}/kindeditor/plugins/code/prettify.js" type="text/javascript"></script>
<script>
			KindEditor.ready(function(K) {
				var editor = K.editor({
					allowFileManager : true
				});
				K('#image1').click(function() {
					editor.loadPlugin('image', function() {
						editor.plugin.imageDialog({
							imageUrl : K('#cover').val(),
							clickFn : function(url, title, width, height, border, align) {
								K('#cover').val(url);
								editor.hideDialog();
							}
						});
					});
				});
				K('#image2').click(function() {
					editor.loadPlugin('image', function() {
						editor.plugin.imageDialog({
							imageUrl : K('banner').val(),
							clickFn : function(url, title, width, height, border, align) {
								K('#banner').val(url);
								editor.hideDialog();
							}
						});
					});
				});
				K('#image3').click(function() {
					editor.loadPlugin('image', function() {
						editor.plugin.imageDialog({
							imageUrl : K('house_banner').val(),
							clickFn : function(url, title, width, height, border, align) {
								K('#house_banner').val(url);
								editor.hideDialog();
							}
						});
					});
				});
				K('#insertfile').click(function() {
					editor.loadPlugin('insertfile', function() {
						editor.plugin.fileDialog({
							fileUrl : K('#url4').val(),
							clickFn : function(url, title) {
								K('#url4').val(url);
								editor.hideDialog();
							}
						});
					});
				});
			});
		</script>
 <script src="/tpl/static/upyun.js"></script>
 <script>

var editor;
KindEditor.ready(function(K) {
editor = K.create('#estate_desc', {
resizeType : 1,
allowPreviewEmoticons : false,
allowImageUpload : true,
uploadJson : '/index.php?g=User&m=Upyun&a=kindedtiropic',
items : [
'source','undo','plainpaste','wordpaste','clearhtml','quickformat','selectall','fullscreen','fontname', 'fontsize','subscript','superscript','indent','outdent','|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline','hr']
});
editor = K.create('#project_brief', {
resizeType : 1,
allowPreviewEmoticons : false,
allowImageUpload : true,
uploadJson : '/index.php?g=User&m=Upyun&a=kindedtiropic',
items : [
'source','undo','plainpaste','wordpaste','clearhtml','quickformat','selectall','fullscreen','fontname', 'fontsize','subscript','superscript','indent','outdent','|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline','hr']
});
editor = K.create('#traffic_desc', {
resizeType : 1,
allowPreviewEmoticons : false,
allowImageUpload : true,
uploadJson : '/index.php?g=User&m=Upyun&a=kindedtiropic',
items : [
'source','undo','plainpaste','wordpaste','clearhtml','quickformat','selectall','fullscreen','fontname', 'fontsize','subscript','superscript','indent','outdent','|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline','hr']
});
});
</script>
<link rel="stylesheet" type="text/css" href="{weimicms::STATICS}/default_user_com.css" media="all">
<div class="content" style="width:95%; background:none; margin-left:25px; border:none; margin-bottom:30px; margin-top:-20px;" >
<include file="Public:hangye"/>
<include file="Huadian:menu"/>

 </div> 
  <div class="msgWrap">
  <form action="" method="post" class="form-horizontal form-validate" novalidate="novalidate">
  <input type="hidden" name="token" value="{weimicms:$token}" />
  <input type="hidden" name="thetype" value="Huadian">
<if condition="$es_data['id'] neq ''">
<input type="hidden" name="id" value="{weimicms:$es_data['id']}" />
</if>
	<div class="control-group">
		<label for="title" class="control-label">图文消息标题：</label>
		<div class="controls">
			<input type="text" name="title" id="title" maxlength="10" class="span4" value="{weimicms:$es_data['title']}" data-rule-required="true"><span class="maroon">*</span><span class="help-inline">触发关键词后返回图文消息标题</span>
		</div>
	</div>
	<div class="control-group">
		<label for="keyword" class="control-label">触发关键词：</label>
		<div class="controls">
			<input type="text" name="keyword" id="keyword" class="span4" data-rule-required="true" value="{weimicms:$es_data['keyword']}"><span class="maroon">*</span><span class="help-inline">只能设置一个关键字</span>
		</div>
	</div>

	<div class="control-group">
		<label for="coverurl" class="control-label">图文消息封面：</label>
		<div class="controls">
      <img class="thumb_img" id="cover_src" src="{weimicms:$es_data['cover']|default='./tpl/static/sucai/Huadian/1.jpg'}" style="max-height:100px;">
     <input type="text" name="cover" value="{weimicms:$es_data['cover']|default='./tpl/static/sucai/Huadian/1.jpg'}" id="cover" class="px" style="width:150px;" ><script src="/tpl/static/upyun.js"></script><a href="###" onclick="upyunPicUpload('cover',700,420,'{weimicms:$token}')" class="ChooseImage">上传</a> 
	  <a href="###" onclick="viewImg('cover')" class="ChooseImage">预览</a>
              <span class="help-inline">建议尺寸：宽720像素，高400像素</span>
          </span>
       </div>
	</div>
	<div class="control-group">
         <label class="control-label">经营主体头部图片：</label>
                                    <div class="controls">
                                        <img class="thumb_img" id="banner_src" src="{weimicms:$es_data['banner']|default='./tpl/static/sucai/Huadian/2.png'}" style="max-height:100px;"> 
                                        
                                            <input type="text" id="banner" name="banner" class="px" value="{weimicms:$es_data['banner']|default='./tpl/static/sucai/Huadian/2.png'}"><script src="/tpl/static/upyun.js"></script><a href="###" onclick="upyunPicUpload('banner',700,420,'{weimicms:$token}')" class="ChooseImage">上传</a>
                  		 <a href="###" onclick="viewImg('banner')" class="ChooseImage">预览</a>                           
                                            <span class="help-inline">建议尺寸：宽720像素，高350像素</span>
                                        </span>
                                    </div>
                                </div>
	<div class="control-group">
		<div class="control-group">
                                    <label class="control-label">鲜花门店头部图片：</label>
                                    <div class="controls">
                                        <img class="thumb_img" id="house_banner_src" src="{weimicms:$es_data['house_banner']|default='./tpl/static/sucai/Huadian/4.png'}" style="max-height:100px;">
                                        <input type="text" name="house_banner" id="house_banner" class="px" value="{weimicms:$es_data['house_banner']|default='./tpl/static/sucai/Huadian/4.png'}"><script src="/tpl/static/upyun.js"></script><a href="###" onclick="upyunPicUpload('house_banner',700,420,'{weimicms:$token}')" class="ChooseImage">上传</a>
                                             <a href="###" onclick="viewImg('house_banner')" class="ChooseImage">预览</a>
                                            <span class="help-inline">建议尺寸：宽720像素，高350像素</span>
                                        </span>
                                    </div>
                                </div>
	</div>

	<div class="control-group">
                                    <label for="album_title" class="control-label">全景相册名称：</label>
                                    <div class="controls">
                                    <select id="panorama_id" name="panorama_id" class="input-medium" data-rule-required="true"> 
                                          <option value="0">请选择360全景相册</option> 
                                            <volist name="panorama" id="vo">
                                               <option value="{weimicms:$vo['pid']}" <if condition="$vo['pid'] eq $es_data['panorama_id']">selected="selected"</if>>{weimicms:$vo['name']}</option>
                                            </volist>
                                        </select>
                                        <span class="maroon">*</span>
                                        <span class="help-inline">如果没有，请先到 <a href="{weimicms::U('Panorama/add',array('token'=>$token))}" class="btn"><strong><font color='red'>360°全景</strong></font></a>添加</span>

                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">服务理念信息：</label>
                                    <div class="controls">
                                     <select id="classify_id" name="classify_id" class="input-medium" data-rule-required="true"> 
                                          <option value="0">请选择公开政务信息</option> 
                                            <volist name="classify" id="vo">
                                               <option value="{weimicms:$vo['cid']}" <if condition="$vo['cid'] eq $es_data['classify_id']">selected="selected"</if>>{weimicms:$vo['name']}</option>
                                            </volist>
                                        </select>
                                        <span class="maroon">*</span>
                                        <span class="help-inline">如果没有，请先到<a href="{weimicms::U('Classify/add',array('token'=>$token))}" class="btn"> <strong><font color='red'>文章分类管理</strong></font></a>添加</span> <span class="maroon">注意：只能添加［图文回复］的［新增图文自定义回复］！</span>
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">预约服务：</label>
                                    <div class="controls">
                                     <select id="res_id" name="res_id" class="input-medium" data-rule-required="true"> 
                                          <option value="0">请选择预约服务版面</option> 
                                            <volist name="reslist" id="vo">
                                               <option value="{weimicms:$vo['rid']}" <if condition="$vo['rid'] eq $es_data['res_id']">selected="selected"</if>>{weimicms:$vo['title']}</option>
                                            </volist>
                                        </select>
                                        <span class="maroon">*</span>
                                        <span class="help-inline">如果没有，请先到<a href="{weimicms::U('Reservation/index',array('token'=>$token))}" class="btn"><strong><font color='red'>预约管理</strong></font></a>添加</span>
                                    </div>
                                </div>
<div class="control-group">
		<label for="place" class="control-label">经营主体地址：</label>
		<div class="controls"> 
			<div class="input-prepend">
				 <input type="text" id="suggestId" class="span4 px"  name="place" value="{weimicms:$es_data['place']}" class="input-xlarge" data-rule-required="true" onchange="loadmap()" value=""/> <span class="maroon">*</span> 
			</div>
		</div>
	</div>
	<div class="control-group">
		<label for="place" class="control-label">联系电话：</label>
		<div class="controls"> 
			<div class="input-prepend">
				 <input type="text" id="suggestId" class="span4 px"  name="tel" value="{weimicms:$es_data['tel']}" class="input-xlarge" data-rule-required="true"> <span class="maroon">*</span> 
			</div>
		</div>
	</div>
    <div class="control-group">
    <label for="suggestId" class="control-label">地图标识：</label>
         <div class="controls">
          <span class="maroon">注意：这个只是模糊定位，准确位置请地图上标注！</span>
           <div id="l-map"  style="width:605px; height:320px;"></div>
            <div id="r-result">
                 <input type="input" class="px" id="lng" value="{weimicms:$es_data['lng']}"  name="lng" style="width:80px;">
                 <input type="input" class="px" id="lat" value="{weimicms:$es_data['lat']}"  name="lat" style="width:80px;">
                 <input  type="hidden"  name="city" class="px" id="city" size="20" value="" /> 
             </div>
             <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:350px;height:auto;"></div>
         </div>
    </div>
<div class="control-group">
         <label for="estate_desc" class="control-label">服务理念简介：</label>
         <div class="controls">
             <textarea class="px" id="estate_desc" name="estate_desc" style="width: 605px; height: 150px;">{weimicms:$es_data['estate_desc']}</textarea>
                                        
         </div>
     </div>
     <div class="control-group">
         <label for="project_brief" class="control-label">经营主体简介：</label>
         <div class="controls">
             <textarea class="px" id="project_brief" name="project_brief" style="width: 605px; height: 150px; ">{weimicms:$es_data['project_brief']}</textarea>
         </div>
     </div>
     <div class="control-group">
        <label for="traffic_desc" class="control-label">服务配套：</label>
        <div class="controls">
            <textarea class="px" id="traffic_desc" name="traffic_desc" style="width: 605px; height: 150px; ">{weimicms:$es_data['traffic_desc']}</textarea>
        </div>
    </div>
 <if condition="$es_data['id'] neq ''">
<input type="hidden" name="id" value="{weimicms:$es_data['id']}" />
</if>
   <div class="form-actions">
			<button id="bsubmit" type="submit" data-loading-text="提交中..." class="btn btn-success">保存</button>　<button type="button" class="btn btn-danger">取消</button>
		</div>
</form>
  </div> 
 
  
        </div>
<script src="http://api.map.baidu.com/api?key=040c55027f5509316877ae67f1ccfd9b&amp;v=1.1&amp;services=true" type="text/javascript"></script>
<script type="text/javascript" src="http://api.map.baidu.com/getscript?v=1.1&amp;ak=&amp;services=true&amp;t=20130716024057"></script>
<link rel="stylesheet" type="text/css" href="http://api.map.baidu.com/res/11/bmap.css">
<script type="text/javascript">
var map = new BMap.Map("l-map");
var myGeo = new BMap.Geocoder();  
//map.addControl(new BMap.MapTypeControl({mapTypes: [BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]}));     //2D图，卫星图

//map.addControl(new BMap.MapTypeControl({anchor: BMAP_ANCHOR_TOP_LEFT}));    //左上角，默认地图控件

//alert(city);
var currentPoint ;
var marker1;
var marker2;
map.enableScrollWheelZoom(); 
//var point = new BMap.Point(116.331398,39.897445);  

map.enableDragging();   
map.enableContinuousZoom();
map.addControl(new BMap.NavigationControl());  
map.addControl(new BMap.ScaleControl());  
map.addControl(new BMap.OverviewMapControl());
var point = new BMap.Point(<php>if($es_data['lng']!="") echo $es_data['lng'];else echo "120.265912"</php>,<php>if($es_data['lat']!="") echo $es_data['lat'];else echo "30.316553"</php>);
doit(point);
window.setTimeout(function(){
auto();
},100);

 function auto(){
 var geolocation = new BMap.Geolocation();  
geolocation.getCurrentPosition(function(r){  
if(this.getStatus() == BMAP_STATUS_SUCCESS){  
//var mk = new BMap.Marker(r.point);  
//map.addOverlay(mk);  
 // point = r.point;  
//map.panTo(r.point); 

var point = new BMap.Point(r.point.lng,r.point.lat);  
marker1 = new BMap.Marker(point);        // 创建标注
map.addOverlay(marker1);
var opts = {
width : 220,     // 信息窗口宽度 220-730
height: 60,     // 信息窗口高度 60-650
title : ""  // 信息窗口标题
}
var infoWindow = new BMap.InfoWindow("定位成功这是你当前的位置!,移动红点标注目标位置，你也可以直接修改上方位置,系统自动定位!", opts);  // 创建信息窗口对象
marker1.openInfoWindow(infoWindow);      // 打开信息窗口
doit(point);

}else {  
 
}  
})
 }
function  doit(point){

//map.centerAndZoom(point,12);  
 

//myGeo.getPoint(city, function(point){ 
if (point) {
//window.external.setlngandlat(point.lng,point.lat);
//alert(point.lng + "  ddd " + point.lat);

 document.getElementById('lat').value = point.lat;
 document.getElementById('lng').value =point.lng;

 
map.setCenter(point);
map.centerAndZoom(point, 15);
map.panTo(point);

var cp = map.getCenter();		
myGeo.getLocation(point, function(result){  
/*if (result){
 document.getElementById('suggestId').value = result.address;
}	*/		
});	






marker2 = new BMap.Marker(point);        // 创建标注  
var opts = {
width : 220,     // 信息窗口宽度 220-730
height: 60,     // 信息窗口高度 60-650
title : ""  // 信息窗口标题
}
var infoWindow = new BMap.InfoWindow("拖拽地图或红点，在地图上用红点标注您的店铺位置。", opts);  // 创建信息窗口对象
marker2.openInfoWindow(infoWindow);      // 打开信息窗口

map.addOverlay(marker2);                     // 将标注添加到地图中

marker2.enableDragging();
marker2.addEventListener("dragend", function(e){
 document.getElementById('lat').value =e.point.lat;
   document.getElementById('lng').value =e.point.lng;
myGeo.getLocation(new BMap.Point(e.point.lng,e.point.lat), function(result){  
if (result){
//$('suggestId').value = result.address;
//$('city').value = result.city;
//			alert(result.address)				
//	window.external.setaddress(result.address);//setarrea(result.address);//
//marker1.setPoint(new BMap.Point(e.point.lng,e.point.lat));        // 移动标注
marker2.setPoint(new BMap.Point(e.point.lng,e.point.lat));     
map.panTo(new BMap.Point(e.point.lng,e.point.lat));
//window.external.setlngandlat(e.point.lng,e.point.lat);
}			
});	
});	

map.addEventListener("dragend", function showInfo(){
var cp = map.getCenter();		
myGeo.getLocation(new BMap.Point(cp.lng,cp.lat), function(result){  
if (result){
 //document.getElementById('suggestId').value = result.address;
 document.getElementById('lat').value =cp.lat;
   document.getElementById('lng').value =cp.lng;
//	window.external.setaddress(result.address);//setarrea(result.address);//
//alert(point.lng + "  ddd " + point.lat);
//marker1.setPoint(new BMap.Point(cp.lng,cp.lat));        // 移动标注
marker2.setPoint(new BMap.Point(cp.lng,cp.lat));     
map.panTo(new BMap.Point(cp.lng,cp.lat));
//window.external.setlngandlat(cp.lng,cp.lat);
}			
});	
});	

map.addEventListener("dragging", function showInfo(){
var cp = map.getCenter();
//marker1.setPoint(new BMap.Point(cp.lng,cp.lat));        // 移动标注
marker2.setPoint(new BMap.Point(cp.lng,cp.lat)); 
map.panTo(new BMap.Point(cp.lng,cp.lat));
map.centerAndZoom(marker2.getPoint(), map.getZoom());
});	


}


//}, province);


}


function loadmap() {
var province =  document.getElementById('city').value;
var city =   document.getElementById('suggestId').value ;
// 将结果显示在地图上，并调整地图视野  
myGeo.getPoint(city, function(point){  
if (point) {
//marker1.setPoint(new BMap.Point(point.lng,point.lat));        // 移动标注
marker2.setPoint(new BMap.Point(point.lng,point.lat));  
//window.external.setlngandlat(marker2.getPoint().lng,marker2.getPoint().lat);
//alert(point.lng + "  ddd " + point.lat);
 document.getElementById('lat').value =point.lat;
   document.getElementById('lng').value =point.lng;
map.panTo(new BMap.Point(marker2.getPoint().lng,marker2.getPoint().lat));
map.centerAndZoom(marker2.getPoint(), map.getZoom());
}}, province);
} 

function setarrea(address,city) {
//$('suggestId').value = address;
//$('city').value=city;
window.setTimeout(function(){
loadmap();
},2000);
}

function initarreawithpoint(lng,lat){
window.setTimeout(function(){
//marker1.setPoint(new BMap.Point(lng,lat));        // 移动标注
marker2.setPoint(new BMap.Point(lng,lat));  
//window.external.setlngandlat(lng,lat);
map.panTo(new BMap.Point(lng,lat));
map.centerAndZoom(marker2.getPoint(), map.getZoom());
}, 2000);	
}


</script>
<include file="Public:footer"/>