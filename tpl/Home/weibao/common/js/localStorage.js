BizQQWPA.define("wpa.visitor","util.log,util.speedReport,util.getJSONP,util.domain,util.pubSub,wpa.filter,wpa.ta,wpa.invite,wpa.wpaMgr,wpa.ta,wpa.kfuin",function(l){var f=l("invite"),a=l("domain"),i=l("filter"),k=l("getJSONP"),d=l("pubSub"),b=l("log"),j=l("speedReport"),c=l("ta"),h=l("kfuin");var e=1;var g="http://visitor.crm2.qq.com/cgi/visitorcgi/ajax/wpa_first_heart_beat.php";return function(o){var r=o.nameAccount;if(!r||r==="undefined"){return}if(f.isLoaded(r)||!i.TA){return}var p,n,m=function(t,s){if(!t||!s){return}if(s.block===e){return}if(i.CRM){s.di=o.di;s.kfuin=o.kfuin;b(r+" try launch slave");f.load(r,t,s)}};d.one("TA.loaded",function(s){p=s;m(p,n)});d.one("Invite.first",function(s){n=s;m(p,n)});c(r,a.topDomain,function(s){d.pub("TA.loaded",s)});var q={nameAccount:r,dm:a.topDomain,title:document.title,url:location.href.split("://")[1].split("?")[0]};k(g,q,function(s){d.pub("Invite.first",s)});o.kfuin&&h.set(r,o.kfuin)}});BizQQWPA.define("wpa.filter","util.domain",function(b){var e="",d="qq.com,pengyou.com,qzoneapp.com,nipic.com,docin.com,51zxw.net,2155.com,xd.com,yto.net.cn,c-c.com,27.cn,05wan.com,alivv.cn,gogo.com,doctorjob.com.cn,emoney.cn,m4.cn,chinaktv.net,yk988.com,bangkaow.com,wsxsp.com,55tools.com,youxi518.com",a="b.qq.com,sales.b.qq.com,guilin.house.qq.com,ta.qq.com,hn.qq.com,nantong.house.qq.com";var c=b("domain");return{TA:function(){var i=c.topDomain,h=/^[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d$/,g=/^localhost$/,f=/^wpa\.b\.qq\.com/;return e.indexOf(i)===-1&&!h.test(i)&&!g.test(i)&&!f.test(c.domain)}(),CRM:function(){try{var j=new RegExp("(^|,)"+c.domain);if(j.test(a)){return true}var i=c.topDomain,h=new RegExp("(^|,)"+i),g=/^[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d$/,k=/^localhost$/;return !h.test(d)&&!g.test(i)&&!k.test(i)}catch(f){}}()}});BizQQWPA.define("wpa.invite","util.log,util.getJSONP,util.proxy,util.domain,util.blockStorage,util.taskMgr,wpa.wpaMgr",function(ab){var H=2000,l=1000,O=2000,Y=2000,N=5000,w=15000,h=3600000,u=1000;var C="is",i="ik",X="msg",b="mh",e="mid",L="slid";var M="0",v="1",S="2",p="0",V="-1",U="|";var G="http://visitor.crm2.qq.com/cgi/visitorcgi/ajax/wpa_heart_beat.php",r="http://visitor.crm2.qq.com/cgi/visitorcgi/ajax/auto_invite.php";var I=0,a="0",s="1",E="2",Z=1;var t="0",Q="1",B="2",A="4",T="20",f="0",D="1",y="2",R="4",W="5";var g="0",j="1",d="1",c="0",K="1";var z=ab("log"),P=ab("getJSONP"),q=ab("proxy"),F=ab("domain"),x=ab("blockStorage"),aa=ab("taskMgr"),o=ab("wpaMgr");var n=function(ad,ac,ae){this.nameAccount=ad;this.uid=ac;this.config=ae;this.genID();this.storage=x(ad);this.monitors={master:aa.newTask(q(this,this.masterMonitor),H).run(),invite:aa.newTask(q(this,this.inviteMonitor),l).run()};this.heartBeat=aa.newTask(q(this,this.heartBeatProcess),Y).run();this.setActive();window.onfocus=q(this,this.setActive);z("slave "+this.id+" launched!")};n.prototype={genID:function(){this.id="slid_"+ +new Date()%1000+"_"+Math.round(Math.random()*100)},masterMonitor:function(){if(J[this.nameAccount]){return}z("monitoring mater state");var ac=this.storage.get(b)||0,ad=+new Date()-parseInt(ac);z("gap of master is "+ad);if(ad>3*O){this.recoverMaster()}},recoverMaster:function(){J[this.nameAccount]=new m(this.nameAccount,this.uid,this.config);z("recover master by slave "+this.id)},inviteMonitor:function(){if(this.isInvited()){this.kill()}else{if(this.isInviting()){if(this.isActive()){this.invite()}}}z("slave "+this.id+" monitoring invite state")},kill:function(){this.monitors.invite.drop();this.heartBeat.drop();var ad=this.storage,ac=[this.id];for(var af=0,ae;ae=ac[af++];){ad.del(ae)}z("slave "+this.id+" killed")},invite:function(){var ac=this.storage.get(i);var ad={wty:Q,nameAccount:this.nameAccount,kfuin:this.config.kfuin,type:T,aty:ac?(ac===p?R:W):R,a:ac||"",iv:K,fsty:g,fposX:d,fposY:j,sv:A,uid:this.uid,dm:F.topDomain,msg:this.storage.get(X)};o.invite(ad,this.config.di);this.storage.set(C,S);z("invited by slave "+this.id)},heartBeatProcess:function(){var ad=this.storage,ac=ad.get(L);if(!ac){ad.set(L,this.id+"|")}else{if(ac.indexOf(this.id+"|")===-1){ad.set(L,this.id+"|"+ac)}}ad.set(this.id,+new Date())},setActive:function(){var ad=this.storage,ac=ad.get(L)||"",ae=this.id+U;if(ac.indexOf(this.id)>-1){ac=ac.replace(ae,"")}ac+=ae;ad.set(L,ac)},isActive:function(){var ac=this.storage.get(L);if(!ac){return false}return ac.substr(0,ac.length-1).split(U).pop()===this.id},isInvited:function(){return this.storage.get(C)===S},isInviting:function(){return this.storage.get(C)===v}};var J={};var m=function(ad,ac,ae){this.nameAccount=ad;this.uid=ac;this.config=ae;this.storage=x(ad);this.genID();this.sleep=false;this.heartBeatURl=ae.hbDomain||G;this.storage.set(e,this.id);this.heartBeatProcess();this.heartBeat=aa.newTask(q(this,this.heartBeatProcess),O).run();this.initWithConfig();z("master launched!")};m.prototype={genID:function(){this.id=+new Date()%1000+"_"+Math.round(Math.random()*100)},setInviteState:function(ac,ae,ad){if(ac===v){this.storage.set(i,ae);this.storage.set(X,ad)}this.storage.set(C,ac)},isInvited:function(){var ac=this.storage.get(C)===S;if(ac){this.recycle();this.isInvited=function(){return true}}return ac},initWithConfig:function(){var ac=this.config;if(ac.r!==I){this.storage.set(b,V);return}if(ac.isAuto===Z){this.storage.set(X,ac.autoMsg);this.autoInviteTimer=setTimeout(q(this,function(){this.autoInvite()}),ac.autoTime*1000)}this.monitors={slave:aa.newTask(q(this,this.slaveMonitor),Y).run(),server:aa.newTask(q(this,this.serverMonitor),N).run(),sleep:aa.newTask(q(this,this.sleepMonitor),h).run()};z("master inited with config")},autoInvite:function(){if(this.isInvited()){return}var ad={nameAccount:this.nameAccount,uid:this.uid};var ac=this.monitors.server;ac.pause();P(r,ad,q(this,function(ae){if(ae.r!==I){ac.run();return}if(!this.isInvited()){this.setInviteState(v,p,this.storage.get(X));aa.once(function(){ac.run()},5000).run()}}))},ajustServerMonitorGap:function(ac){this.monitors.server.setGap(Math.min(Math.max(N,ac),w))},serverMonitor:function(){var ad=this.storage.get(C);if(this.sleep){return}var ac={nameAccount:this.nameAccount,uid:this.uid};if(ad===v){ac.inviteState=s}if(ad===S){ac.inviteState=E}P(this.heartBeatURl,ac,q(this,function(ae){if(ae.r!==I){return}if(ae.gap){this.ajustServerMonitorGap(ae.gap*1000)}if(ae.inviteState===a){return}if(ae.inviteState===s){this.setInviteState(v,ae.kfext,ae.inviteMsg);return}if(ae.inviteState===E){this.setInviteState(S)}}))},slaveMonitor:function(){if(this.isInvited()){this.monitors.slave.drop()}var ae=this.storage,af=ae.get(L);if(!af){return}af=af.split(U);var ac="",aj=+new Date(),ai,ag,ad;for(var ah=0;ag=af[ah++];){z("monitoring slave "+ag+" state");ai=ae.get(ag)||0;ad=aj-parseInt(ai);z("gap of slave "+ag+" is "+ad);if(ad>3*Y){ae.del(ag);z("clear slave "+ag+" in storage")}else{ac+=ag+U}}ae.set(L,ac)},sleepMonitor:function(){var ac=this.storage.get(L)||"",ad=ac.substr(0,ac.length-1).split(U).pop();if(this.sleep){if(this.activeSlave!==ad){this.activeSlave=ad;this.sleep=false;this.monitors.sleep.setGap(h)}}else{if(this.activeSlave===ad){this.sleep=true;this.monitors.sleep.setGap(u)}else{this.activeSlave=ad}}},kill:function(){J[this.nameAccount]=undefined;if(this.monitors){this.monitors.server.drop();this.monitors.slave.drop();this.heartBeat.drop();clearTimeout(this.autoInviteTimer)}z("master killed")},recycle:function(){var ad=this.storage,ac=[i,X];for(var af=0,ae;ae=ac[af++];){ad.del(ae)}z("storage recycled")},heartBeatProcess:function(){var ac=this.storage;if(ac.get(e)!==this.id){this.kill();return false}this.storage.set(b,+new Date())}};var k={};return{load:function(ad,ac,ae){if(this.isLoaded(ad)){z(ad+" slave already running");return}var af=new n(ad,ac,ae);k[ad]?k[ad].push(af):k[ad]=[af]},isLoaded:function(ac){return typeof k[ac]!=="undefined"}}});BizQQWPA.define("util.blockStorage","util.sessionStorage",function(b){var c=b("sessionStorage");var a=function(d){this.blockIndex=d};a.get=function(d){return c.get(d)};a.set=function(d,e){return c.set(d,e)};a.del=function(d){return c.del(d)};a.find=function(){return c.find.apply(c,arguments)};a.prototype={set:function(d,e){return c.setItem(this.blockIndex+d,e)},get:function(d){return c.getItem(this.blockIndex+d)},del:function(d){return c.removeItem(this.blockIndex+d)}};return factory=function(d){return new a(d)}});BizQQWPA.define("util.sessionStorage","util.localStorage,util.cookie",function(a){var g=a("util.localStorage"),c=a("util.cookie");var f="IESESSION";var d=function(){return !!c.get(f)},b=function(h){c.set(f,h,null,"/")},e=function(){var i=new RegExp("^"+f+"[\\S]+$"),j=[];for(var h=0;h<g.length;h++){if(g.key(h).match(i)){j.push(g.key(h))}}while(j.length){g.removeItem(j[0]);j.shift()}};if(!d()){b("alive");e()}return{setItem:function(h,i){g.setItem(f+h,i)},getItem:function(h){return g.getItem(f+h)},removeItem:function(h){g.removeItem(f+h)},clear:e}});BizQQWPA.define("util.localStorage","util.cookie,lang.trim",function(c){var a=c("util.cookie"),d=c("lang.trim");var h="IELS";var e=3153600000000;var g=document,i=new RegExp("(?:^|[ ;])"+h+"[^=]+=([^;$])"),b=function(j){return h+j},f=function(m){var o=g.cookie.split(";"),k=0,l=o.length,n=[],j;if(m){for(;k<l;k++){if(j=i.exec(o[k])){n.push(j[1]);m(j[1])}}}else{for(;k<l;k++){(j=i.exec(o[k]))&&n.push(j[1])}}return n};return window.localStorage||{length:f().length,key:function(j){return f()[j]||null},getItem:function(j){return a.get(b(j))},setItem:function(j,k){a.set(b(j),k,null,"/",e)},removeItem:function(j){a.del(j)},clear:function(){f(function(j){a.del(d(j.split("=")[0]))})}}});