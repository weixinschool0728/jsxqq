<include file="Storenew:header"/>
<form method="post" action="{weimicms::U('Storenew/grouponordersave',array('token'=>$_GET['token'],'wecha_id'=>$_GET['wecha_id'], 'twid' => $twid,'cid' => $cid))}" id="FromID">
<div>
	<div class="m-ck-module">
	<h1>收货信息
		<if condition="$addrSign neq ''">
			<a id="editAddress" style="float:right;" href="javascript:getaddr();">使用微信收货地址</a>
		</if>
	</h1>
	<ul>
		<li class="addr-info">
					<label>收货人姓名：</label>
					<span>
						<input name="orid" value="{weimicms:$orid}" type="hidden" />
						<input name="truename" id="truename" class="input" value="{weimicms:$fans.truename}" type="text" placeholder="输入收货人姓名" />
					</span>
					<label>手机：</label>
					<span>
						<input name="tel" class="input" id="tel" value="{weimicms:$fans.tel}" type="text" placeholder="输入您的收货电话" />
					</span>
					<label>详细地址：</label>
					<span>
						<input name="address" class="input" id="address" value="{weimicms:$fans.address}" type="text" placeholder="输入您的收货地址" />
					</span>
					<label>备注信息：</label>
					<span>
						<input name="note" class="input" id="note" value="{weimicms:$fans.note}" type="text" placeholder="如送货时间、样式等要求" />
					</span>
					<label>联系方式保存到用户库</label>
					<label><input type="checkbox" value="1" name="saveinfo" id="saveinfo" style="width: 16px;" checked="true"/></label>
		</li>
	</ul>
	</div>
	<div class="m-ck-module">
		<h1>付款方式</h1>
		<ul id="payment_mode" class="rd">
			<li>
				<label><input name="paymode" value="1" type="radio" checked><img src="/tpl/static/storenew/images/icon-huod.png" width="15" height="15"/>处理订单</label>
				<if condition="$fans['balance'] gt 0">
				<label><input name="paymode" value="4" type="radio"><img src="/tpl/static/storenew/images/icon-weixin.png" width="15" height="15"/>会员卡支付</label>
				</if>
			</li>    
		</ul>
	</div>
	<!-- <div class="m-ck-module">
		<h1>送货方式</h1>
		<ul id="shipping" class="rd"><input id="delivery" type="hidden" name="delivery" value="">
		<li shipping="15"><label><input name="dt_id" value="535" type="radio">普通快递<b class="c_red">0元</b></label></li></ul>
	</div> -->
<div class="m-ck-module">
<h1>团购商品清单</h1>
<ul>
<ul class="m-cart-list">
		<li>
			<span class="pic"><img src="{weimicms:$p.logourl}" width="75" height="75"></span>
			<span class="con">
			<i class="t">{weimicms:$p.name}</i>
			<p><label>数量：</label>1　<label>团购价：</label><span class="price">￥{weimicms:$p.price}</span></p>
			</span>
		</li>
</ul>
</ul>
</div>
<div class="m-cart-toal m-checkout-toal">
<p id="price_total" class="check">商品价值：<b>{weimicms:$totalCount}</b>　元<br>
<!-- 优惠金额：0元<br> -->
您共需支付：<b id="totalmoney">{weimicms:$totalCount}</b>　元</p>
<div id="show_msg" class="tip_blue"></div>
<input id="totalCount" type="hidden" name="totalCount" value="{weimicms:$totalCount}">
<input id="orderid" type="hidden" name="orderid" value="{weimicms:$orderid}">
<p class="act"><a id="sub_order" href="javascript:;" class="checkout">确认，提交订单</a></p>
</div>
</form>
</div>


<script language="javascript">
document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
WeixinJSBridge.call('hideToolbar');
});

function getaddr(){
	WeixinJSBridge.invoke('editAddress',{
		"appId" : "{weimicms:$addrSign['appId']}",
		"scope" : "jsapi_address",
		"signType" : "sha1",
		"addrSign" : "{weimicms:$addrSign['addrSign']}",
		"timeStamp" : "{weimicms:$addrSign['timeStamp']}",
		"nonceStr" : "{weimicms:$addrSign['nonceStr']}",
	},function(res){
	//若res 中所带的返回值不为空，则表示用户选择该返回值作为收货地址。否则若返回空，则表示用户取消了这一次编辑收货地址。
		if(res.err_msg == 'edit_address:ok'){
			//alert("收件人："+res.userName+"  联系电话："+res.telNumber+"  收货地址："+res.proviceFirstStageName+res.addressCitySecondStageName+res.addressCountiesThirdStageName+res.addressDetailInfo+"  邮编："+res.addressPostalCode);
			$('#truename').val(res.userName);
			$('#tel').val(res.telNumber);
			$('#address').val(res.proviceFirstStageName+res.addressCitySecondStageName+res.addressCountiesThirdStageName+res.addressDetailInfo);
		}else{
			//alert(res.err_msg);
		}
	
	});
}
</script>


<script>
var scale = "{weimicms:$setting['score']}";
var totalscore = "{weimicms:$fans['total_score']}";
$(document).ready(function(){
	var total = $("#totalmoney").html();
	$("#score").keyup(function(){
		var num = parseInt($(this).val());
		if (isNaN(num)) {
			num = 0;
		}
		if (num > totalscore) {
			$(this).val(totalscore);
			return floatNotify.simple('您填写的积分超过了您的可用积分');
			return false;
		}
		var t = total - num/scale;
		if (t <= 0) {
			var s = total * scale;
			if (s < 1) {
				s = 1;
			}
			$(this).val(s);
			t = 0;
		}
		$("#totalmoney").html(t);
	});
	$("#sub_order").click(function(){
		var userName=$('#truename').val();
		if($.trim(userName) == ""){
			return floatNotify.simple('请填写姓名');
			return false;
		}
		var userPhone = $("#tel").val()
		if ($.trim(userPhone) == "") {
			return floatNotify.simple('请填写您的手机号码');
			return false;
		}
		var patrn = /^1\d{10}$/;
		if (!patrn.exec($.trim(userPhone))) {
			return floatNotify.simple('手机号格式错误');
			return false;
		}
		var address = $("#address").val()
		if ($.trim(address) == "") {
			return floatNotify.simple('请填写您的详细地址');
			return false;
		}
		$("#FromID").submit();
		return false;
	});
});
</script>
<include file="Storenew:foot"/>
</body>
<script type="text/javascript">
window.shareData = {  
            "moduleName":"Store",
            "moduleID":"0",
            "imgUrl": "{weimicms:$f_siteUrl}{weimicms::U('Storenew/orderCart',array('token' => $_GET['token'], 'twid' => $mytwid, 'cid' => $cid))}", 
            "timeLineLink": "{weimicms:$f_siteUrl}{weimicms::U('Storenew/orderCart',array('token' => $_GET['token'], 'twid' => $mytwid, 'cid' => $cid))}",
            "sendFriendLink": "{weimicms:$f_siteUrl}{weimicms::U('Storenew/orderCart',array('token' => $_GET['token'], 'twid' => $mytwid, 'cid' => $cid))}",
            "weiboLink": "{weimicms:$f_siteUrl}{weimicms::U('Storenew/orderCart',array('token' => $_GET['token'], 'twid' => $mytwid, 'cid' => $cid))}",
            "tTitle": "{weimicms:$metaTitle}",
            "tContent": "{weimicms:$metaTitle}"
        };
</script>
{weimicms:$shareScript}
</html>